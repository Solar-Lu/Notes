# CRADLE: Cross-Backend Validation to Detect and Localize Bugs in Deep Learning Libraries

## 一、核心思想

提出了一种全新的深度学习软件测试方法，核心思想是：**与其纠结模型对不对，不如先回答它通过现有库的实现有没有错。**

作者指出，深度学习系统的高风险应用（如自动驾驶、医疗诊断）要求极高的可靠性，但目前大多数测试方法只关注模型层面的准确率，而忽略了底层库（TensorFlow、CNTK、Theano）是否存在实现缺陷。由于这些底层库在不同后端上的实现细节差异巨大，且输出结果常常带有浮点误差，开发者很难判断一次错误的预测究竟是模型能力不足，还是后端代码有 bug。

## 二、设计

为了解决这个问题，CRADLE 设计了两阶段策略。

**第一阶段：** 系统把同一个预训练模型分别在多个后端上跑一遍，用两种距离度量来捕捉"真正可疑"的差异：
- 对分类任务，它比较 ground-truth 标签在不同后端输出中的排名差异
- 对回归任务，则比较两个后端输出与真实值的平均绝对偏差差异

只有当差异超过自适应阈值，且影响足够多的输入样本时，才认定为一次值得关注的不一致。

**第二阶段：** 一旦检测到不一致，CRADLE 会记录模型在前向传播过程中的所有中间层输出，构建一张"执行偏差图"。通过计算每一层对差异的放大程度，系统可以高亮最早引入异常的那一次函数调用，从而把排查范围从几百个后端函数缩小到极少数可疑代码。

**案例：** 在 InceptionResNetV2 模型上，CNTK 后端把 batch_normalization 里的方差计算写错，导致一张"培养皿"图片被错分成"座钟"。CRADLE 不仅发现了 580 张触发不一致的图片，还把问题精确定位到 batch_normalization 这一处实现，开发者随后就在 Keras 2.2.1 中修复了该 bug。

## 三、实验

实验规模很大：30 个公开预训练模型、11 个数据集（ImageNet、MNIST、KGS 围棋、Udacity 自动驾驶等）、15 个 Keras 版本、3 个主流后端。

**结果：** 一共发现 12 个真实 bug，其中 7 个属于"跨后端不一致"的语义 bug，5 个是会导致崩溃的健壮性 bug；目前已有 9 个被官方修复，3 个属于新发现的未知 bug。所有 104 个独特不一致都生成了定位图，人工只需 1–2 小时就能把相似根因聚类成 7 个 root bug。端到端运行时间通常不到 5 分钟，验证了方法的实用性。

**其他典型 bug：**
- Padding 方案在奇偶尺寸组合下行为不一致，导致 ResNet、MobileNet 等模型漏检目标
- Theano 的 AveragePooling 在 SAME padding 时错误地把 padding 像素算进平均，造成 InceptionV3 等模型输出偏移

这些 bug 波及 15 个以上的模型，开发者已通过模型级补丁或后端源码修复。

## 四、局限

- 目前只针对推理阶段且依赖预训练模型，训练阶段或更复杂结构的覆盖不足
- 检测逻辑以"外部可观测差异"为准，可能遗漏仅影响内部状态的 bug
- 不一致聚类仍需人工

**未来工作：** 将扩展到 PyTorch、JAX 等后端，引入变异模型提升覆盖率，并开发自动化聚类工具。

## 总结

CRADLE 把传统软件工程里的差分测试和故障定位思想成功迁移到深度学习领域，第一次让"后端实现是否正确"这个问题变得可测、可定位、可修复。它不仅帮助开发者发现并修复了多个真实缺陷，也为深度学习系统的持续集成与质量保证提供了新的基础工具。

## 实验测试

### 测试命令
```bash
python test.py
```

### 实验结果

#### 1. 使用同一个模型检测
![实验1](jpg/2025.8.25-8.31(CRADLE)/1.png)

#### 2. 不同轻量级模型检测
![实验2](jpg/2025.8.25-8.31(CRADLE)/2.png)

#### 3. 不同模型形状差异导致的不一致性
![实验3](jpg/2025.8.25-8.31(CRADLE)/3.png)

#### 4. 模型架构复杂度差异分析
![实验4](jpg/2025.8.25-8.31(CRADLE)/4.png)

**分析：** 例如 VGG16 vs Lightweight CNN 存在 12.4% 不一致性，主要是由于 VGG16 是 46 层的深度网络而 Lightweight CNN 只有 8 层，架构复杂度差异巨大。

**后续计划：** 后期将根据模型的提示，修改阈值的部分进一步进行检测。