## 核心问题：从“相似性”到“相关性”的范式转变

- **传统方法的局限**  
  现有的二进制函数匹配技术（如 BSim、discovRE、SAFE、Gemini）主要依赖语法或结构相似性（控制流图、指令序列、神经网络嵌入）。  
  但在逆向工程实践中，工程师更关注**功能性相关性**——匹配能否帮助理解代码意图与行为。

- **现实世界的复杂性**  
  编译器、优化级别、库版本差异会使同一功能函数的代码结构巨变，显著降低基于相似性的匹配器准确率；同一函数也存在不同变体。

- **现有挑战**
  - 不完整的参考库：不可能拥有所有函数的所有变体。  
  - 匹配模糊性：库中可能存在多个结构相似但功能不同的函数，难以区分。

&gt; **RevDecode 的核心理念**：函数的相关性不仅取决于自身，还取决于其所在的“上下文”。  
&gt; 通过分析函数在二进制文件中的邻居关系提升匹配准确性。

---

## 2. RevDecode 的解决方案：上下文感知的重排序框架

- **定位**：增强框架，接收现有匹配器的原始相似性分数，利用上下文信息重排序，输出更相关、更准确的候选函数列表。

---

## 3. 系统详细设计
![revcode](jpg/revcode(1).png)
### 3.1 图构建

将整二进制文件的函数匹配问题建模为**带权有向分层图**：

| 元素 | 说明 |
|---|---|
| **Layers** | 每层对应目标二进制中的一个未知函数（按内存顺序排列）。 |
| **Nodes** | 每层含多个节点，每个节点代表参考库中的一个候选匹配函数。 |
| **Edges** | 若两未知函数在内存中相邻，则对应层间每对候选节点相连，编码“相邻出现”的上下文可能性。 |
| **特殊节点** | - **Start / End**：路径起止。&lt;br&gt;- **Uncertain**：每层一个，表示“未找到相关匹配”，应对参考库不完整。 |

---

### 3.2 边权重计算：四大分数

每条边权重为以下四个分数的**加权和**（越高表示过渡可能性越大）：
![revcode](jpg/revcode(2).png)
1. **相似性分数**  
   来自底层匹配器（如 BSim），经 Sigmoid 归一化。

2. **置信度分数**  
   基于 TF-IDF 思想，衡量两函数共享特征的**独特性**；共享特征越稀有，分数越高。

3. **邻接分数**（上下文亲密度）
   - 同一库：+0.70  
   - 同一版本：+0.03  
   - 同一优化级别：+0.02  
   - 同一编译单元：+0.05  
   （实验调优，最大化 DCG）

4. **库分数**（稀有性指示）
   - 公式：`(该库函数数量 / 参考库总函数数量)`  
   - 小众库函数得分更高，匹配更具指示意义。

---

### 3.3 图遍历与排名：类 Viterbi 算法

目标：寻找 **Start→End** 的最大权重路径，代表最一致、最相关的函数匹配序列。

- **前向传递**  
  动态规划计算每层节点从 Start 出发的最大累积权重（类似 Viterbi）。

- **后向传递与排名生成**  
  从 End 反向遍历，每层节点按与最大权重路径的“接近程度”排名；路径上节点获 Rank 1。  
  确保排名兼顾自身相似性与上下文一致性。

---
![revcode](jpg/revcode(3).png)
### 3.4 级联匹配（性能优化）

解决慢速匹配器（SAFE、Gemini）耗时问题：

1. 快速匹配器（BSim）先筛 Top-K（如 250）候选；  
2. 仅对该子集用慢速精确匹配器重算相似性；  
3. 用精确分数建图并重排。  

**效果**：匹配时间从**数天→数小时**，精度几乎无损。

---

### 3.5 GPU 加速

面向大规模图（千级函数 × 百级候选）的遍历瓶颈：

- **细粒度遍历**  
  每 GPU 线程处理一条边，层内高度并行。

- **分段估计遍历**  
  将图分段独立处理再合并，以空间换时间，提升并行度与可扩展性。

---

## 4. 实验评估与结果

| 数据集 | 描述 |
|---|---|
| **通用数据集** | GNU Binutils、BusyBox、OpenSSL 真实二进制。 |
| **Frankenbinaries** | 人工合成，模拟嵌入式固件，多开源库随机组合。 |

- **评估指标**  
  Tie-aware NDCG（考虑排名顺序与相关性等级）。

- **关键结果**
  - **排名质量显著提升**  
    - 通用数据集：56.3 % (discovRE) → 97.3 % (BSim) 的函数排名改善。  
    - Frankenbinaries：72.3 % → 98.8 %。  
  - **高效性**  
    - GPU 加速：图遍历从**分钟级→秒级**。  
    - 级联匹配：让原本不可行的 ML 匹配器变得实用。  
  - **优势场景**  
    恢复因编译差异而结构不同的相关匹配；区分特征模糊的相似函数。

---

## 5. 局限性

- 若参考库**根本不存在**相关函数，RevDecode 亦无法恢复。  
- 若一**系列不相关匹配**在上下文中相互支撑，可能导致系统性错误。  
- 在上下文信号**无法区分**的极端模糊情况下，提升效果有限。

---
![revcode](jpg/revcode(4).png)
## 总结

RevDecode 通过将二进制函数匹配问题巧妙地建模为**上下文感知的图遍历问题**，成功弥补了传统相似性匹配与逆向工程师所需功能性相关性之间的差距。